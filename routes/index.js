const express = require('express');
const router = express.Router();
const pool = require('../db/pool');
const { requireRole, requireAnyRole, requireMasterAdmin } = require('../middlewares/auth');
const qr = require('qrcode');
const { v4: uuidv4 } = require('uuid');
// ===== Auto clean attendancetoken every 30s =====
const TOKEN_TTL_SECONDS = 10;      // ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö TTL ‡πÉ‡∏ô /qr/:id/token
const CLEAN_INTERVAL_MS  = 3_600_000; // 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á

setInterval(() => {
  pool.query(
    `DELETE FROM attendancetoken
      WHERE is_used = TRUE
         OR created_at < NOW() - ($1 || ' seconds')::interval`,
    [TOKEN_TTL_SECONDS]
  ).catch(e => console.error('token cleanup error:', e));
}, CLEAN_INTERVAL_MS);
//------------------------------------------------------------------
//--------------------------LOGIN----------------------------------
//------------------------------------------------------------------
router.get('/login', (req, res) => {
  const error = req.session.error || null;
  req.session.error = null;
  res.render('login', { error });
});

router.get('/logout', (req, res) => {
  req.session.destroy();
  res.redirect('/login');
});

router.post('/login', async (req, res) => {
  const { username, password } = req.body;

  try {
    const adminResult = await pool.query(
      'SELECT * FROM Admin WHERE Username = $1 AND Password = $2',
      [username, password]
    );
    if (adminResult.rows.length > 0) {
      const admin = adminResult.rows[0];

      req.session.user = {
      adminid: admin.adminid,
      username: admin.username,
      name: admin.name,                     // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
      is_master: admin.is_master === true
    };
      req.session.role = 'admin';
      return res.redirect('/admin');
}

    const teacherResult = await pool.query(
      'SELECT * FROM Teacher WHERE Username = $1 AND Password = $2',
      [username, password]
    );
    if (teacherResult.rows.length > 0) {
      req.session.user = teacherResult.rows[0];
      req.session.role = 'teacher';
      return res.redirect('/classroom');
    }

    const studentResult = await pool.query(
      'SELECT * FROM Student WHERE Username = $1 AND Password = $2',
      [username, password]
    );
    if (studentResult.rows.length > 0) {
      req.session.user = studentResult.rows[0];
      req.session.role = 'student';
      return res.redirect('/classroom');
    }

    req.session.error = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
    return res.redirect('/login');
  } catch (err) {
    console.error(err);
    req.session.error = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
    return res.redirect('/login');
  }
});

//------------------------------------------------------------------
//--------------------------SHOW USERLIST--------------------------
//------------------------------------------------------------------
router.get('/admin', requireRole('admin'), (req, res) => {
  res.render('admin', {
    user: req.session.user,          // user ‡∏ó‡∏µ‡πà login
    currentUser: req.session.user,   // ‡∏™‡πà‡∏á currentUser ‡∏î‡πâ‡∏ß‡∏¢
    currentRole: req.session.role,   // ‡∏™‡πà‡∏á currentRole ‡∏î‡πâ‡∏ß‡∏¢
    showNavbar: true
  });
});


// ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö
router.get('/admin/list/admin', requireRole('admin'), async (req, res) => {
  if (!req.session.user.is_master) {
    return res.redirect('/admin');
  }

  try {
    const result = await pool.query('SELECT * FROM Admin ORDER BY AdminId ASC');
    res.render('userlist', {
      title: '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
      users: result.rows,
      role: 'admin',
      currentUser: req.session.user,
      currentRole: req.session.role,
      showNavbar: true
    });
  } catch (err) {
    console.error(err);
    req.session.error = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô';
    res.redirect('/admin');
  }
});


// ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π
router.get('/admin/list/teacher', requireRole('admin'), async (req, res) => {
  try {
    const result = await pool.query('SELECT * FROM Teacher ORDER BY TeacherId ASC');
    res.render('userlist', {
      title: '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π',
      users: result.rows,
      role: 'teacher',
      currentUser: req.session.user,
      currentRole: req.session.role,
      showNavbar: true
    });
  } catch (err) {
    console.error(err);
    req.session.error = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π';
    res.redirect('/admin');
  }
});

//  ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
router.get('/admin/list/student', requireRole('admin'), async (req, res) => {
  try {
    const result = await pool.query('SELECT * FROM Student ORDER BY StudentId ASC');
    res.render('userlist', {
      title: '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
      users: result.rows,
      role: 'student',
      currentUser: req.session.user,
      currentRole: req.session.role,
      showNavbar: true
    });
  } catch (err) {
    console.error(err);
    req.session.error = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
    res.redirect('/admin');
  }
});

//------------------------------------------------------------------
//--------------------------FORM ADD/EDIT USER----------------------
//------------------------------------------------------------------
router.get('/admin/add/:role', requireRole('admin'), (req, res) => {
  const { role } = req.params;

  // ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° admin ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà master admin
  if (role === 'admin' && !req.session.user.is_master) {
    return res.redirect('/admin');
  }

  if (!['admin', 'teacher', 'student'].includes(role)) return res.redirect('/admin');

  const error = req.session.error || null;
  req.session.error = null;

  res.render('add_user', {
    role,
    error,
    currentUser: req.session.user,
    currentRole: req.session.role,
    showNavbar: true
  });
});

router.post('/admin/add/:role', requireRole('admin'), async (req, res) => {
  const { role } = req.params;
  const { id, firstname, surname, username, password, email } = req.body;

  

  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
  if (!id || !firstname || !username || !password || (role !== 'admin' && (!surname || !email))) {
    req.session.error = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á';
    return res.redirect(`/admin/add/${role}`);
  }

  try {
    let checkQuery = '';
    let checkParams = [];

    if (role === 'admin') {
      checkQuery = 'SELECT 1 FROM Admin WHERE AdminId = $1 OR Username = $2';
      checkParams = [id, username];
    } else if (role === 'teacher') {
      checkQuery = 'SELECT 1 FROM Teacher WHERE TeacherId = $1 OR Username = $2 OR Email = $3';
      checkParams = [id, username, email];
    } else if (role === 'student') {
      checkQuery = 'SELECT 1 FROM Student WHERE StudentId = $1 OR Username = $2 OR Email = $3';
      checkParams = [id, username, email];
    } else {
      return res.redirect('/admin');
    }

    const checkResult = await pool.query(checkQuery, checkParams);
    if (checkResult.rows.length > 0) {
      req.session.error = 'ID, Username ‡∏´‡∏£‡∏∑‡∏≠ Email ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
      return res.redirect(`/admin/add/${role}`);
    }

    let insertQuery;
    let insertParams;

    if (role === 'admin') {
      insertQuery = 'INSERT INTO Admin (AdminId, Name, Username, Password) VALUES ($1, $2, $3, $4)';
      insertParams = [id, firstname, username, password];
    } else if (role === 'teacher') {
      insertQuery = 'INSERT INTO Teacher (TeacherId, firstname, Surname, Username, Password, Email) VALUES ($1, $2, $3, $4, $5, $6)';
      insertParams = [id, firstname, surname, username, password, email];
    } else if (role === 'student') {
      insertQuery = 'INSERT INTO Student (StudentId, firstname, Surname, Username, Password, Email) VALUES ($1, $2, $3, $4, $5, $6)';
      insertParams = [id, firstname, surname, username, password, email];
    }

    await pool.query(insertQuery, insertParams);
    res.redirect(`/admin/list/${role}`);
  } catch (err) {
    console.error(err);
    req.session.error = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    res.redirect(`/admin/add/${role}`);
  }
});

router.get('/admin/edit/:role/:id', requireRole('admin'), async (req, res, next) => {
  const { role, id } = req.params;

  if (role === 'admin') {
    // admin ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô master ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    return requireMasterAdmin(req, res, async () => {
      // ‡πÇ‡∏Ñ‡πâ‡∏î‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• admin ‡πÅ‡∏•‡∏∞ render
      let query = 'SELECT * FROM Admin WHERE AdminId = $1';

      try {
        const result = await pool.query(query, [id]);
        if (result.rows.length === 0) return res.redirect('/admin');

        const error = req.session.error || null;
        req.session.error = null;

        res.render('edit_user', {
          user: result.rows[0],
          role,
          error,
          currentUser: req.session.user,
          currentRole: req.session.role,
          showNavbar: true
        });
      } catch (err) {
        console.error(err);
        req.session.error = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        res.redirect('/admin');
      }
    });
  } else {
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö teacher/student ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
    let query;
    if (role === 'teacher') {
      query = 'SELECT * FROM Teacher WHERE TeacherId = $1';
    } else if (role === 'student') {
      query = 'SELECT * FROM Student WHERE StudentId = $1';
    } else {
      return res.redirect('/admin');
    }

    try {
      const result = await pool.query(query, [id]);
      if (result.rows.length === 0) return res.redirect('/admin');

      const error = req.session.error || null;
      req.session.error = null;

      res.render('edit_user', {
        user: result.rows[0],
        role,
        error,
        currentUser: req.session.user,
        currentRole: req.session.role,
        showNavbar: true
      });
    } catch (err) {
      console.error(err);
      req.session.error = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      res.redirect('/admin');
    }
  }
});

router.post('/admin/edit/:role/:id', requireRole('admin'), async (req, res) => {
  const { role, id } = req.params;
  const { firstname, surname, username, password, email } = req.body;

  try {
    let query;
    let params;
    const hasPassword = password && password.trim() !== '';

    if (role === 'admin') {
      if (hasPassword) {
        query = 'UPDATE Admin SET Name = $1, Username = $2, Password = $3 WHERE AdminId = $4';
        params = [firstname, username, password, id];
      } else {
        query = 'UPDATE Admin SET Name = $1, Username = $2 WHERE AdminId = $3';
        params = [firstname, username, id];
      }
    } else if (role === 'teacher') {
      if (hasPassword) {
        query = 'UPDATE Teacher SET firstname = $1, surname = $2, username = $3, password = $4, email = $5 WHERE TeacherId = $6';
        params = [firstname, surname, username, password, email, id];
      } else {
        query = 'UPDATE Teacher SET firstname = $1, surname = $2, username = $3, email = $4 WHERE TeacherId = $5';
        params = [firstname, surname, username, email, id];
      }
    } else if (role === 'student') {
      if (hasPassword) {
        query = 'UPDATE Student SET firstname = $1, surname = $2, username = $3, password = $4, email = $5 WHERE StudentId = $6';
        params = [firstname, surname, username, password, email, id];
      } else {
        query = 'UPDATE Student SET firstname = $1, surname = $2, username = $3, email = $4 WHERE StudentId = $5';
        params = [firstname, surname, username, email, id];
      }
    } else {
      return res.redirect('/admin');
    }

    await pool.query(query, params);
    res.redirect(`/admin/list/${role}`);
  } catch (err) {
    console.error(err);
    req.session.error = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    res.redirect(`/admin/edit/${role}/${id}`);
  }
});


router.post('/admin/delete/:role/:id', requireRole('admin'), async (req, res) => {
  const { role, id } = req.params;

  if (role === 'admin') {
    // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà master admin ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö admin ‡πÉ‡∏î ‡πÜ
    if (!req.session.user.is_master) {
      return res.status(403).send('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
    }

    // ‡∏´‡πâ‡∏≤‡∏° master ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
    if (String(req.session.user.adminid) === String(id)) {
      req.session.error = '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ';
      return res.redirect('/admin/list/admin');
    }
  }

  let query;
  if (role === 'admin') {
    query = 'DELETE FROM Admin WHERE AdminId = $1';
  } else if (role === 'teacher') {
    query = 'DELETE FROM Teacher WHERE TeacherId = $1';
  } else if (role === 'student') {
    query = 'DELETE FROM Student WHERE StudentId = $1';
  } else {
    return res.redirect('/admin');
  }

  try {
    await pool.query(query, [id]);
    res.redirect(`/admin/list/${role}`);
  } catch (err) {
    console.error(err);
    req.session.error = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    res.redirect(`/admin/list/${role}`);
  }
});

//------------------------------------------------------------------
//--------------------------SHOW CLASSROOM--------------------------
//------------------------------------------------------------------

router.get('/classroom', requireAnyRole(['teacher', 'student']), async (req, res) => {
  try {
    const role = req.session.role;
    let classrooms = [];

    if (role === 'teacher') {
      const teacherId = req.session.user.teacherid;
      const result = await pool.query(
        `SELECT c.*, CONCAT(t.firstname, ' ', t.surname) AS teacher_fullname
         FROM Classroom c
         JOIN Teacher t ON c.teacherid = t.teacherid
         WHERE c.teacherid = $1`,
        [teacherId]
      );
      classrooms = result.rows;

    } else if (role === 'student') {
      const studentId = req.session.user.studentid;

      const result = await pool.query(
        `SELECT DISTINCT c.*, CONCAT(t.firstname, ' ', t.surname) AS teacher_fullname
         FROM Classroom c
         JOIN Teacher t ON c.teacherid = t.teacherid
         JOIN Classroom_Student cs ON c.classroomid = cs.classroomid
         WHERE cs.studentid = $1`,
        [studentId]
      );
      classrooms = result.rows;

    } else {
      return res.redirect('/login');
    }

    res.render('classroom', {
      classrooms,
      role,
      showNavbar: true,
      currentUser: req.session.user,
      currentRole: role
    });

  } catch (err) {
    console.error(err);
    res.render('classroom', {
      classrooms: [],
      role: req.session.role,
      showNavbar: true,
      currentUser: req.session.user,
      currentRole: req.session.role,
      error: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'
    });
  }
});

//------------------------------------------------------------------
//--------------------------ADD CLASSROOM---------------------------
//------------------------------------------------------------------
// GET: ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏£‡∏π)
router.get('/classroom/add', requireRole('teacher'), (req, res) => {
  const error = req.session.error || null;
  req.session.error = null;

  res.render('addclassroom', {
    error,
    showNavbar: true,
    currentUser: req.session.user,   // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å user ‡πÄ‡∏õ‡πá‡∏ô currentUser
    currentRole: req.session.role    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å role ‡πÄ‡∏õ‡πá‡∏ô currentRole
  });
});


// POST: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å classroom ‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏£‡∏π)
router.post('/classroom/add', requireRole('teacher'), async (req, res) => {
  const { ClassroomName, RoomNumber, Description, MinAttendancePercent } = req.body;

  if (!ClassroomName || !RoomNumber || !Description || !MinAttendancePercent) {
    req.session.error = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á';
    return res.redirect('/classroom/add');
  }

  try {
    await pool.query(
      'INSERT INTO Classroom (ClassroomName, RoomNumber, Description, MinAttendancePercent, TeacherId) VALUES ($1, $2, $3, $4, $5)',
      [ClassroomName, RoomNumber, Description, MinAttendancePercent, req.session.user.teacherid]
    );
    res.redirect('/classroom');
  } catch (err) {
    console.error(err);
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‡∏ï‡∏≠‡∏ô insert ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á error ‡∏û‡∏£‡πâ‡∏≠‡∏° navbar:
    res.render('addclassroom', {
      error: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
      showNavbar: true,
      currentUser: req.session.user,
      currentRole: req.session.role
    });
  }
});

//------------------------------------------------------------------
//--------------------------VIEW CLASSROOM---------------------------
//------------------------------------------------------------------
router.get('/classroom/view/:id', requireAnyRole(['teacher', 'student']), async (req, res) => {
  const classroomId = req.params.id;
  try {
    const result = await pool.query(`
      SELECT c.*, t.firstname || ' ' || t.surname AS teacher_fullname
      FROM Classroom c
      JOIN Teacher t ON c.teacherid = t.teacherid
      WHERE c.classroomid = $1
    `, [classroomId]);

    if (result.rows.length === 0) return res.redirect('/classroom');

    res.render('viewclassroom', {
      classroom: result.rows[0],
      showNavbar: true,
      currentUser: req.session.user,
      currentRole: req.session.role
    });
  } catch (err) {
    console.error(err);
    res.redirect('/classroom');
  }
});

//------------------------------------------------------------------
//--------------------------EDIT CLASSROOM---------------------------
//------------------------------------------------------------------

router.get('/classroom/edit/:id', requireRole('teacher'), async (req, res) => {
  const classroomId = req.params.id;

  try {
    const result = await pool.query('SELECT * FROM Classroom WHERE ClassroomId = $1', [classroomId]);
    if (result.rows.length === 0) {
      req.session.error = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
      return res.redirect('/classroom');
    }

    res.render('editclassroom', {
      classroom: result.rows[0],
      showNavbar: true,
      currentUser: req.session.user,
      currentRole: req.session.role,
      error: req.session.error || null   // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    });

    req.session.error = null; // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏•‡πâ‡∏ß
  } catch (err) {
    console.error(err);
    req.session.error = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
    res.redirect('/classroom');
  }
});
// POST: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
router.post('/classroom/edit/:id', requireRole('teacher'), async (req, res) => {
  const { ClassroomName, RoomNumber, Description, MinAttendancePercent } = req.body;
  const id = req.params.id;

  if (!ClassroomName || !RoomNumber || !Description || !MinAttendancePercent) {
    req.session.error = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á';
    return res.redirect(`/classroom/edit/${id}`);
  }

  try {
    await pool.query(
      'UPDATE Classroom SET ClassroomName=$1, RoomNumber=$2, Description=$3, MinAttendancePercent=$4 WHERE ClassroomId=$5',
      [ClassroomName, RoomNumber, Description, MinAttendancePercent, id]
    );
    res.redirect('/classroom');
  } catch (err) {
    console.error(err);
    req.session.error = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
    res.redirect(`/classroom/edit/${id}`);
  }
});


// Route ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
router.post('/classroom/delete/:id', requireRole('teacher'), async (req, res) => {
  const classroomId = req.params.id;
  const teacherId = req.session.user.teacherid;

  try {
    await pool.query('DELETE FROM Classroom WHERE ClassroomId = $1 AND TeacherId = $2', [classroomId, teacherId]);
    res.redirect('/classroom');
  } catch (err) {
    console.error(err);
    res.redirect('/classroom');
  }
});

//------------------------------------------------------------------
//--------------------------FORM ADD student to classroom----------------------
//------------------------------------------------------------------
router.get('/classroom/add-students', requireRole('teacher'), async (req, res) => {
  try {
    const teacherId = req.session.user.teacherid;
    const classroomId = req.query.classroomId;

    if (!classroomId) {
      req.session.error = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
      return res.redirect(`/classroom/add-students/${id}`);
    }

    // Query ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á Classroom ‡∏ï‡∏≤‡∏° TeacherId ‡πÅ‡∏•‡∏∞ ClassroomId
    const classroomRes = await pool.query(
      'SELECT ClassroomName FROM Classroom WHERE ClassroomId = $1 AND TeacherId = $2',
      [classroomId, teacherId]
    );

    if (classroomRes.rows.length === 0) {
      req.session.error = '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ';
      return res.redirect(`/classroom`);
    }

    res.render('add_student_to_classroom', {
  classroomId,
  classroomName: classroomRes.rows[0].classroomname, // ‚úÖ ‡πÉ‡∏ä‡πâ lowercase
  error: '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ',
  showNavbar: true,
  currentUser: req.session.user,
  currentRole: req.session.role,
  error: null
});
  } catch (err) {
    console.error(err);
    res.status(500).send('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
  }
});


router.post('/classroom/add-students', requireRole('teacher'), async (req, res) => {
  const { studentIds, ClassroomId } = req.body;

  try {
    const teacherId = req.session.user.teacherid;

    const classroomRes = await pool.query(
      'SELECT classroomid FROM classroom WHERE classroomid = $1 AND teacherid = $2',
      [ClassroomId, teacherId]
    );

    if (classroomRes.rows.length === 0) {
      // render ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°
      const classroomNameResult = await pool.query(
        'SELECT classroomname FROM classroom WHERE classroomid = $1',
        [ClassroomId]
      );
      const classroomName = classroomNameResult.rows.length > 0 ? classroomNameResult.rows[0].classroomname : '';

      return res.render('add_student_to_classroom', {
        classroomId: ClassroomId,
        classroomName,
        error: '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ',
        showNavbar: true,
        currentUser: req.session.user,
        currentRole: req.session.role,
      });
    }

    const classroomId = classroomRes.rows[0].classroomid;

    const ids = studentIds
      .split(',')
      .map(id => id.trim())
      .filter(id => id.length > 0);

    const existing = await pool.query(
      'SELECT studentid FROM classroom_student WHERE classroomid = $1',
      [classroomId]
    );

    const existingIds = existing.rows.map(row => row.studentid.toString());

    const newIds = ids.filter(id => !existingIds.includes(id));

    if (newIds.length === 0) {
      const classroomNameResult = await pool.query(
        'SELECT classroomname FROM classroom WHERE classroomid = $1',
        [ClassroomId]
      );
      const classroomName = classroomNameResult.rows.length > 0 ? classroomNameResult.rows[0].classroomname : '';

      return res.render('add_student_to_classroom', {
        classroomId: ClassroomId,
        classroomName,
        error: '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
        showNavbar: true,
        currentUser: req.session.user,
        currentRole: req.session.role,
      });
    }

    for (let studentId of newIds) {
      await pool.query(
        'INSERT INTO classroom_student (classroomid, studentid) VALUES ($1, $2)',
        [classroomId, studentId]
      );
    }

    return res.redirect(`/classroom/${classroomId}/students`);
  } catch (err) {
    console.error('‡πÄ‡∏Å‡∏¥‡∏î error:', err);

    const classroomNameResult = await pool.query(
      'SELECT classroomname FROM classroom WHERE classroomid = $1',
      [ClassroomId]
    );
    const classroomName = classroomNameResult.rows.length > 0 ? classroomNameResult.rows[0].classroomname : '';

    return res.render('add_student_to_classroom', {
      classroomId: ClassroomId,
      classroomName,
      error: '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',
      showNavbar: true,
      currentUser: req.session.user,
      currentRole: req.session.role,
    });
  }
});

//------------------------------------------------------------------
//--------------------------list student in class----------------------
//------------------------------------------------------------------
router.get('/classroom/:id/students', requireAnyRole(['teacher', 'student']), async (req, res) => {
  const classroomId = req.params.id;

  try {
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    const classRes = await pool.query(
      `SELECT * FROM Classroom WHERE ClassroomId = $1`, [classroomId]
    );
    if (classRes.rows.length === 0) return res.redirect('/classroom');

    // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á
    const studentRes = await pool.query(`
      SELECT s.studentid, s.firstname, s.surname
      FROM classroom_student cs
      JOIN student s ON cs.studentid = s.studentid
      WHERE cs.classroomid = $1
      ORDER BY s.studentid ASC
    `, [classroomId]);

    res.render('liststudentinclass', {
      classroom: classRes.rows[0],
      students: studentRes.rows,
      showNavbar: true,
      currentUser: req.session.user,
      currentRole: req.session.role
    });
  } catch (err) {
    console.error(err);
    res.redirect('/classroom');
  }
});


router.post('/classroom/:classroomId/students/:studentId/remove', requireRole('teacher'), async (req, res) => {
  const { classroomId, studentId } = req.params;
  const teacherId = req.session.user.teacherid;

  try {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    const classroomCheck = await pool.query(
      'SELECT * FROM classroom WHERE classroomid = $1 AND teacherid = $2',
      [classroomId, teacherId]
    );

    if (classroomCheck.rows.length === 0) {
      return res.status(403).send('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ');
    }

    // ‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    await pool.query(
      'DELETE FROM classroom_student WHERE classroomid = $1 AND studentid = $2',
      [classroomId, studentId]
    );

    res.redirect(`/classroom/${classroomId}/students`);
  } catch (err) {
    console.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:', err);
    res.status(500).send('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
  }
});

//------------------------------------------------------------------
//--------------------------QR TOKEN SYSTEM-------------------------
//------------------------------------------------------------------

// ‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏ó‡πÄ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 10 ‡∏ß‡∏¥ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
router.get('/qr/:id/token', requireRole('teacher'), async (req, res) => {
  const classroomId = parseInt(req.params.id, 10);
  const force = String(req.query.force || '').trim() === '1';

  try {
    let row;

    if (!force) {
      const q = await pool.query(`
        SELECT token, created_at
        FROM attendancetoken
        WHERE classroomid = $1
          AND is_used = FALSE
          AND created_at > NOW() - ($2 || ' seconds')::interval
        ORDER BY created_at DESC
        LIMIT 1
      `, [classroomId, TOKEN_TTL_SECONDS]);
      if (q.rowCount > 0) row = q.rows[0];
    }

    if (!row) {
      const token = uuidv4();
      const ins = await pool.query(`
        INSERT INTO attendancetoken (token, classroomid, created_at, is_used)
        VALUES ($1, $2, NOW(), FALSE)
        RETURNING token
      `, [token, classroomId]);
      row = ins.rows[0];
    }

    const baseUrl = `${req.protocol}://${req.get('host')}`;
    const url = `${baseUrl}/attendance/confirm/${row.token}`;

    return res.json({
      token: row.token,
      url,
      ttl: TOKEN_TTL_SECONDS   // üëà ‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ = Date.now()+ttl*1000
    });
  } catch (e) {
    console.error('qr token error:', e);
    return res.status(500).json({ error: 'cannot create token' });
  }
});

// ‡∏™‡∏£‡πâ‡∏≤‡∏á QR token (‡∏Ñ‡∏£‡∏π‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏π QR ‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥)
// ‡∏Ñ‡∏£‡∏π‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ
router.get('/api/qr-status/:classroomId', requireRole('teacher'), async (req, res) => {
  const classroomId = parseInt(req.params.classroomId, 10);
  const token = (req.query.token || '').toString().trim();

  try {
    const r = await pool.query(`
      SELECT is_used
      FROM attendancetoken
      WHERE classroomid = $1
        AND token = $2
        AND created_at > NOW() - ($3 || ' seconds')::interval
    `, [classroomId, token, TOKEN_TTL_SECONDS]);

    if (r.rowCount === 0) {
      // ‡πÑ‡∏°‡πà‡∏û‡∏ö/‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‚Üí ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ
      return res.json({ exists: false, is_used: true });
    }
    return res.json({ exists: true, is_used: r.rows[0].is_used === true });
  } catch (e) {
    console.error('qr-status error:', e);
    return res.status(500).json({ error: 'error' });
  }
});

// ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ß‡∏° QR + ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
router.get('/qr/:id', requireRole('teacher'), async (req, res) => {
  const classroomId = req.params.id;
  const selectedDate = req.query.date || new Date().toISOString().split('T')[0];

  try {
    const studentQuery = await pool.query(`
      SELECT
        s.studentid,
        s.firstname || ' ' || s.surname AS fullname,
        COALESCE(a.status, 'Absent') AS status,
        TO_CHAR(a."time", 'HH24:MI') AS checkin_time
      FROM classroom_student cs
      JOIN student s ON cs.studentid = s.studentid
      LEFT JOIN attendance a
        ON a.studentid = s.studentid
       AND a.classroomid = cs.classroomid
       AND a.date = $2
      WHERE cs.classroomid = $1
      ORDER BY s.firstname
    `, [classroomId, selectedDate]);

    const rows = studentQuery.rows;

    // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö 'Late' ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡πÉ‡∏ô includes)
    const presentCount = rows.reduce((n, r) => n + (r.status === 'Present' ? 1 : 0), 0);
    const absentCount  = rows.length - presentCount;

    return res.render('qr', {
      classroomId,
      students: studentQuery.rows,
      presentCount,
      absentCount,
      showNavbar: true,
      currentUser: req.session.user,
      currentRole: 'teacher',
      selectedDate
    });
  } catch (err) {
    console.error('Error loading QR page:', err);
    req.session.error = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ QR ‡πÑ‡∏î‡πâ';
    res.redirect('/classroom');

  }
});

// ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πÅ‡∏Å‡∏ô token ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠
// ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πÅ‡∏Å‡∏ô ‚Üí ‡∏ï‡∏£‡∏ß‡∏à token ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ confirm
router.post('/api/scan', requireRole('student'), async (req, res) => {
  try {
    const raw = (req.body.token || '').toString().trim();
    const m = raw.match(/\/attendance\/confirm\/([A-Za-z0-9-]{10,})/i);
    const token = m ? m[1] : raw;

    const q = await pool.query(`
      SELECT classroomid
      FROM attendancetoken
      WHERE token = $1
        AND is_used = FALSE
        AND created_at > NOW() - ($2 || ' seconds')::interval
    `, [token, TOKEN_TTL_SECONDS]);

    if (q.rowCount === 0) {
      return res.status(400).json({ error: 'Token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß' });
    }
    return res.json({ redirect: `/attendance/confirm/${token}` });
  } catch (e) {
    console.error('api/scan redirect error:', e);
    return res.status(500).json({ error: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' });
  }
});

// ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô (‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)
router.get('/scan', requireRole('student'), (req, res) => {
  res.render('scan', {
    currentUser: req.session.user,
    currentRole: req.session.role,
    showNavbar: true
  });
});
router.get('/attendance/scan', requireRole('student'), (req, res) => {
  res.render('scan', {
    currentUser: req.session.user,
    currentRole: req.session.role,
    showNavbar: true
  });
});
router.get('/api/classroom/:id/attendance', requireRole('teacher'), async (req, res) => {
  const classroomId = req.params.id;
  const selectedDate = req.query.date || new Date().toISOString().split('T')[0];

  try {
    const result = await pool.query(`
      SELECT
        s.studentid,
        s.firstname || ' ' || s.surname AS fullname,
        COALESCE(a.status, 'Absent') AS status,
        TO_CHAR(a."time", 'HH24:MI') AS checkin_time
      FROM classroom_student cs
      JOIN student s ON cs.studentid = s.studentid
      LEFT JOIN attendance a
        ON a.studentid = s.studentid
       AND a.classroomid = cs.classroomid
       AND a.date = $2
      WHERE cs.classroomid = $1
      ORDER BY s.firstname
    `, [classroomId, selectedDate]);

    res.set('Cache-Control', 'no-store');
    return res.json({ students: result.rows });
  } catch (err) {
    console.error('api/classroom attendance error:', err);
    return res.status(500).json({ error: 'failed' });
  }
});

// ‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ QR (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏≠)

router.get('/classroom/:id/select-date', async (req, res) => {
  const { id } = req.params;
  try {
    const result = await pool.query(
      `SELECT classroomid, classroomname 
       FROM classroom 
       WHERE classroomid = $1`, 
      [id]
    );

    if (result.rows.length === 0) {
      return res.status(404).send("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
    }

    const classroom = result.rows[0];

    res.render('select_date', {
      classroomId: classroom.classroomid,
      classroomName: classroom.classroomname,  // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ ejs
      currentUser: req.session.user,
      currentRole: req.session.role,
      showNavbar: true
    });
  } catch (err) {
    console.error(err);
    res.status(500).send("Server Error");
  }
});

router.post('/classroom/:id/generate-token', async (req, res) => {
  const classroomId = req.params.id;
  const selectedDate = req.body.date || new Date().toISOString().split('T')[0];
  return res.redirect(`/qr/${classroomId}?date=${selectedDate}`);
});


// ========== ‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏î‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô QR) ==========
// GET /attendance/confirm/:token ‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
router.get('/attendance/confirm/:token', requireRole('student'), async (req, res) => {
  const { token } = req.params;
  const student = req.session.user;
  if (!student || !student.studentid) return res.redirect('/login');

  try {
    const tok = await pool.query(`
      SELECT t.classroomid, c.classroomname
      FROM attendancetoken t
      JOIN classroom c ON c.classroomid = t.classroomid
      WHERE t.token = $1
        AND t.is_used = FALSE
        AND t.created_at > NOW() - ($2 || ' seconds')::interval
    `, [token, TOKEN_TTL_SECONDS]);

    // ‚ùå token ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ/‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‚Üí alert ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ scan
    if (tok.rowCount === 0) {
      return res
        .status(400)
        .type('html')
        .send(`<!doctype html><html lang="th"><head><meta charset="utf-8"></head>
<body>
<script>
  alert(${JSON.stringify('Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏')});
  window.location.replace(${JSON.stringify('/attendance/scan')});
</script>
<noscript>
  <p>Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</p>
  <a href="/attendance/scan">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</a>
</noscript>
</body></html>`);
    }

    const { classroomid, classroomname } = tok.rows[0];

    const belong = await pool.query(
      `SELECT 1 FROM classroom_student WHERE classroomid = $1 AND studentid = $2`,
      [classroomid, student.studentid]
    );

    // ‡πÄ‡∏Ñ‡∏™‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô: ‡∏¢‡∏±‡∏á render not_enrolled ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
    if (belong.rowCount === 0) {
      return res.status(403).render('not_enrolled', {
        classroomName: classroomname,
        studentName: student.firstname
          ? `${student.firstname} ${student.surname || ''}`.trim()
          : (student.name || ''),
        showNavbar: true,
        currentUser: req.session.user,
        currentRole: req.session.role
      });
    }

    const now = new Date();
const dateTH = now.toLocaleDateString('th-TH', { timeZone: 'Asia/Bangkok' });
const timeTH = now.toLocaleTimeString('th-TH', { timeZone: 'Asia/Bangkok', hour: '2-digit', minute: '2-digit' });

    // ‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥: ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ confirm
    return res.render('attendance_confirm', {
      classroomName: classroomname,
      date: dateTH,
      time: timeTH,
      studentId: student.studentid,
      token,
      showNavbar: true,
      currentUser: req.session.user,
      currentRole: req.session.role
    });
  } catch (err) {
    console.error('confirm error:', err);
    // ‚ö†Ô∏è error ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‚Üí alert ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ scan
    return res
      .status(500)
      .type('html')
      .send(`<!doctype html><html lang="th"><head><meta charset="utf-8"></head>
<body>
<script>
  alert(${JSON.stringify('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô')});
  window.location.replace(${JSON.stringify('/attendance/scan')});
</script>
<noscript>
  <p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>
  <a href="/attendance/scan">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</a>
</noscript>
</body></html>`);
  }
});


// ========== ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠" ==========
// ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô + ‡πÑ‡∏°‡πà‡∏Å‡∏¥‡∏ô token ‡∏ñ‡πâ‡∏≤‡πÄ‡∏î‡πá‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
router.post('/attendance/confirm', requireRole('student'), async (req, res) => {
  const token = (req.body.token || '').toString().trim();
  const student = req.session.user;

  // helper ‡∏™‡πà‡∏á alert ‡πÅ‡∏•‡πâ‡∏ß redirect
  const alertAndRedirect = (status, message, redirect = '/attendance/scan') => {
    return res
      .status(status)
      .type('html')
      .send(`<!doctype html><html lang="th"><head><meta charset="utf-8"></head>
<body>
<script>
  alert(${JSON.stringify(message)});
  // ‡πÉ‡∏ä‡πâ replace() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏Å‡∏î‡∏¢‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏î‡πâ‡∏á alert ‡∏ã‡πâ‡∏≥
  window.location.replace(${JSON.stringify(redirect)});
</script>
<noscript>
  <p>${message}</p>
  <a href="${redirect}">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</a>
</noscript>
</body></html>`);
  };

  try {
    const t = await pool.query(
      `
      SELECT classroomid
      FROM attendancetoken
      WHERE token=$1 AND is_used=FALSE
        AND created_at > NOW() - ($2 || ' seconds')::interval
      `,
      [token, TOKEN_TTL_SECONDS]
    );
    if (t.rowCount === 0) {
      return alertAndRedirect(400, 'Token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏');
    }

    const classroomId = t.rows[0].classroomid;

    const belong = await pool.query(
      `SELECT 1 FROM classroom_student WHERE classroomid=$1 AND studentid=$2`,
      [classroomId, student.studentid]
    );
    if (belong.rowCount === 0) {
      // ‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°: ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ not_enrolled
      return res.status(403).render('not_enrolled', {
        classroomName: '',
        studentName: `${student.firstname} ${student.surname}`,
        showNavbar: true,
        currentUser: req.session.user,
        currentRole: req.session.role,
      });
    }

    const exist = await pool.query(
      `
      SELECT 1 FROM attendance
      WHERE classroomid=$1 AND studentid=$2 AND date=CURRENT_DATE
      `,
      [classroomId, student.studentid]
    );
    if (exist.rowCount > 0) {
      return alertAndRedirect(409, '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ');
    }

    const lock = await pool.query(
      `
      UPDATE attendancetoken
         SET is_used=TRUE
       WHERE token=$1 AND is_used=FALSE
         AND created_at > NOW() - ($2 || ' seconds')::interval
       RETURNING token
      `,
      [token, TOKEN_TTL_SECONDS]
    );
    if (lock.rowCount === 0) {
      return alertAndRedirect(400, 'Token ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏');
    }

    await pool.query(
      `
      INSERT INTO attendance (studentid, classroomid, date, "time", status)
      VALUES ($1, $2,
        (NOW() AT TIME ZONE 'Asia/Bangkok')::date,
        (NOW() AT TIME ZONE 'Asia/Bangkok')::time,
        'Present');
      `,
      [student.studentid, classroomId]
    );

    return alertAndRedirect(200, '‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  } catch (err) {
    console.error('submit confirm error:', err);
    return alertAndRedirect(500, '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠');
  }
});
//------------------------------------------------------------------
//--------------------------‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ CLASSROOM---------------------------
//------------------------------------------------------------------
// ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô)
router.get('/classroom/:id/history', requireRole('teacher'), async (req, res) => {
  const classroomId = req.params.id;
  const teacherId   = req.session.user.teacherid;
  const selectedDate = (req.query.date || new Date().toISOString().slice(0,10)); // YYYY-MM-DD

  // ‡πÅ‡∏õ‡∏•‡∏á YYYY-MM-DD -> DD/MM/YYYY (‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)
  const [y, m, d] = selectedDate.split('-');
  const displayDate = `${d}/${m}/${y}`;

  try {
    const classRes = await pool.query(
      `SELECT classroomid, classroomname
       FROM classroom
       WHERE classroomid = $1 AND teacherid = $2`,
      [classroomId, teacherId]
    );
    if (classRes.rows.length === 0) return res.status(403).send('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ');

    // ‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å firstname, surname ‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ a.time ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
    const detailsRes = await pool.query(`
      SELECT
        s.studentid,
        s.firstname,
        s.surname,
        COALESCE(a.status, 'Absent') AS status,
        TO_CHAR(a.time, 'HH24:MI')   AS checkin_time
      FROM classroom_student cs
      JOIN student s ON cs.studentid = s.studentid
      LEFT JOIN attendance a
        ON a.studentid = s.studentid
       AND a.classroomid = cs.classroomid
       AND a.date = $2
      WHERE cs.classroomid = $1
      ORDER BY s.studentid ASC
    `, [classroomId, selectedDate]);

    const totalStudents = detailsRes.rows.length;
const presentCount  = detailsRes.rows.filter(r => r.status === 'Present').length;
const absentCount   = totalStudents - presentCount;

// üëâ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏¢
const hasAnyAttendance = presentCount > 0;

res.render('teacher_history_by_date', {
  classroom: classRes.rows[0],
  selectedDate,
  displayDate,
  totalStudents,
  presentCount,
  absentCount,
  students: detailsRes.rows,
  hasAnyAttendance,       // << ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà EJS
  showNavbar: true,
  currentUser: req.session.user,
  currentRole: req.session.role
});

  } catch (err) {
    console.error('history error:', err);
    res.status(500).send('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
  }
});

// ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ "‡∏ó‡∏±‡πâ‡∏á‡∏´‡πâ‡∏≠‡∏á" (‡∏ù‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå)

router.get('/classroom/:id/attendance-scores', requireRole('teacher'), async (req, res) => {
  const classroomId = req.params.id;
  const teacherId   = req.session.user.teacherid;

  try {
    // 1) ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    const c = await pool.query(
      `SELECT classroomid, classroomname, minattendancepercent
         FROM classroom
        WHERE classroomid = $1 AND teacherid = $2`,
      [classroomId, teacherId]
    );
    if (c.rows.length === 0) return res.status(403).send('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ');
    const classroom  = c.rows[0];
    const minPercent = classroom.minattendancepercent || 0;

    // 2) ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≤‡∏ö/‡∏ß‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ
    const totalRes = await pool.query(
      `SELECT COUNT(DISTINCT date)::int AS total_sessions
         FROM attendance
        WHERE classroomid = $1`,
      [classroomId]
    );
    const totalSessions = totalRes.rows[0].total_sessions;

    // 3) ‡∏£‡∏ß‡∏°‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô ‚Äî ‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Present
    const statsRes = await pool.query(`
      SELECT
        s.studentid,
        s.firstname,
        s.surname,
        COUNT(a.*) FILTER (WHERE a.status = 'Present')::int AS present_count
      FROM classroom_student cs
      JOIN student s ON s.studentid = cs.studentid
      LEFT JOIN attendance a
        ON a.classroomid = cs.classroomid
       AND a.studentid   = s.studentid
      WHERE cs.classroomid = $1
      GROUP BY s.studentid, s.firstname, s.surname
      ORDER BY s.studentid
    `, [classroomId]);

    // 4) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì absent + ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå + ‡∏ú‡πà‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô
    const rows = statsRes.rows.map(r => {
      const present = Number(r.present_count) || 0;
      const absent  = Math.max(0, totalSessions - present);
      const percent = totalSessions > 0 ? Math.round((present / totalSessions) * 100) : 0; // ‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Present
      const isPass  = percent >= minPercent;

      return {
        studentid: r.studentid,
        firstname: r.firstname,
        surname:   r.surname,
        present,
        absent,
        percent,
        isPass
      };
    });

    res.render('teacher_classroom_scores', {
      classroom,
      minPercent,
      totalSessions,
      scores: rows,
      hasAnySession: totalSessions > 0,
      showNavbar: true,
      currentUser: req.session.user,
      currentRole: req.session.role
    });
  } catch (err) {
    console.error('scores error:', err);
    res.status(500).send('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠');
  }
});


// ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á "‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà" ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ
router.get('/student/classroom/:id/attendance-history', requireRole('student'), async (req, res) => {
  const classroomId = req.params.id;
  const studentId   = req.session.user.studentid;

  try {
    // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ
    const belong = await pool.query(
      `SELECT 1 FROM classroom_student WHERE classroomid = $1 AND studentid = $2`,
      [classroomId, studentId]
    );
    if (belong.rowCount === 0) return res.status(403).send('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ');

    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á
    const cls = await pool.query(
      `SELECT classroomid, classroomname FROM classroom WHERE classroomid = $1`,
      [classroomId]
    );
    if (cls.rowCount === 0) return res.redirect('/classroom');
    const classroom = cls.rows[0];

    // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
    const rec = await pool.query(
      `SELECT 
         TO_CHAR(date, 'DD/MM/YYYY') AS display_date,
         TO_CHAR(time, 'HH24:MI')    AS display_time,
         status
       FROM attendance
       WHERE classroomid = $1 AND studentid = $2
       ORDER BY date DESC, time DESC`,
      [classroomId, studentId]
    );

    res.render('student_attendance_history', {
      classroom,                // ‡πÉ‡∏ä‡πâ classroom.classroomname ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ï‡πâ‡∏´‡∏±‡∏ß‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
      records: rec.rows,        // [{display_date, display_time, status}, ...]
      hasRecords: rec.rowCount > 0,
      showNavbar: true,
      currentUser: req.session.user,
      currentRole: req.session.role
    });
  } catch (err) {
    console.error('student history error:', err);
    res.status(500).send('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠');
  }
});

// ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á "‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà" ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ
router.get('/student/classroom/:id/attendance-score', requireRole('student'), async (req, res) => {
  const classroomId = req.params.id;
  const studentId   = req.session.user.studentid;

  try {
    // 1) ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô
    const belong = await pool.query(
      `SELECT 1 FROM classroom_student WHERE classroomid = $1 AND studentid = $2`,
      [classroomId, studentId]
    );
    if (belong.rowCount === 0) {
      return res.status(403).send('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ');
    }

    // 2) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô + ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥
    const cls = await pool.query(
      `SELECT classroomid, classroomname, minattendancepercent
         FROM classroom
        WHERE classroomid = $1`,
      [classroomId]
    );
    if (cls.rowCount === 0) return res.redirect('/classroom');

    const classroom  = cls.rows[0];
    const minPercent = classroom.minattendancepercent || 0;

    // 3) ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≤‡∏ö/‡∏ß‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ
    const totalRes = await pool.query(
      `SELECT COUNT(DISTINCT date)::int AS total_sessions
         FROM attendance
        WHERE classroomid = $1`,
      [classroomId]
    );
    const totalSessions = totalRes.rows[0].total_sessions;

    // 4) ‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "Present" ‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ
    const presentRes = await pool.query(
      `SELECT COUNT(*)::int AS c
         FROM attendance
        WHERE classroomid = $1 AND studentid = $2 AND status = 'Present'`,
      [classroomId, studentId]
    );
    const present = presentRes.rows[0].c;

    // 5) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì absent ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Present)
    const absent  = Math.max(0, totalSessions - present);
    const percent = totalSessions > 0 ? Math.round((present / totalSessions) * 100) : 0;
    const isPass  = percent >= minPercent;

    // 6) ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà view
    res.render('student_attendance_score', {
      classroom,        // { classroomid, classroomname, minattendancepercent }
      totalSessions,    // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      present,          // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Present)
      absent,           // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏î = total - present
      percent,          // %
      minPercent,       // ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥
      isPass,           // ‡∏ú‡πà‡∏≤‡∏ô/‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô
      hasAnySession: totalSessions > 0,
      showNavbar: true,
      currentUser: req.session.user,
      currentRole: req.session.role
    });
  } catch (err) {
    console.error('student self-score error:', err);
    res.status(500).send('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô');
  }
});

module.exports = router;
