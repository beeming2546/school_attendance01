<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>แก้ไขห้องเรียน</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    .form-row{margin-bottom:14px;display:flex;align-items:center;gap:10px}
    .form-row label{width:180px;font-weight:600;margin:0}
    .form-row input[type="text"],
    .form-row input[type="number"],
    .form-row select{flex:1}
    .required{color:#d33;font-weight:700;margin-left:4px}
    .help{display:block;margin:-6px 0 10px 180px;color:#6c757d;font-size:.9rem}
    .btn-group{display:flex;justify-content:center;gap:12px;margin-top:22px}
    .btn-group .btn{min-width:150px}

    /* ข้อความใต้ input ให้อยู่ตำแหน่งเดียวกันกับกล่องกรอก */
    .under-stack{ margin-left:190px; display:flex; flex-direction:column; gap:4px; }
    .under-stack .note, .under-stack #dupHint{ margin:0; line-height:1.35; }
    .note{ color:#000 !important; } /* คำแนะนำเป็นสีดำ */

    /* ปุ่ม primary เมื่อ disabled -> เทา */
    .btn-primary:disabled, .btn-primary.disabled, .btn-primary[disabled]{
      background-color:#6c757d!important; border-color:#6c757d!important;
      color:#fff!important; cursor:not-allowed; opacity:1!important; box-shadow:none!important;
    }
  </style>
</head>
<body>
  <% if (showNavbar) { %>
    <%- include('partials/navbar', { currentUser, currentRole }) %>
  <% } %>

  <div class="container" style="max-width:720px;margin:20px auto;padding:0 15px">
    <h2 class="mb-3 text-center">แก้ไขข้อมูลห้องเรียน</h2>

    <% if (error) { %>
      <div class="alert alert-danger text-center"><%= error %></div>
    <% } %>

    <form id="editClassForm"
          action="/classroom/edit/<%= classroom.classroomid %>"
          method="POST"
          onsubmit="return handleSubmit(event);">

      <!-- ชื่อห้อง -->
      <div class="form-row">
        <label for="ClassroomName">ชื่อห้องเรียน:</label>
        <input id="ClassroomName" type="text" name="ClassroomName"
               value="<%= classroom.classroomname || '' %>" required placeholder="เช่น Database กลุ่ม 1 หรือ DB sec 2">
        <span class="required">*</span>
      </div>
      <div class="under-stack">
        <span id="dupHint" class="text-danger small"></span>
        <small class="note">คำแนะนำ: ชื่อชั้นเรียนให้ตั้งเป็น = ชื่อชั้นเรียน กลุ่ม/sec 1,2,3 เช่น DB กลุ่ม 1 หรือ DB sec 2</small>
      </div>

      <!-- เลขห้อง -->
      <div class="form-row">
        <label for="RoomNumber">เลขห้อง:</label>
        <input id="RoomNumber" type="text" name="RoomNumber"
               value="<%= classroom.roomnumber || '' %>" required placeholder="เช่น 2612 หรือ LAB-2">
        <span class="required">*</span>
      </div>

      <!-- คำอธิบาย -->
      <div class="form-row">
        <label for="Description">คำอธิบายชั้นเรียน:</label>
        <input id="Description" type="text" name="Description"
               value="<%= classroom.description || '' %>" required placeholder="รายละเอียดสั้นๆ ของชั้นเรียน">
        <span class="required">*</span>
      </div>

      <!-- เปอร์เซ็นต์ขั้นต่ำ -->
      <div class="form-row">
        <label for="MinAttendancePercent">เปอร์เซ็นต์เข้าเรียนขั้นต่ำ:</label>
        <div class="d-flex align-items-center gap-2">
          <input id="MinAttendancePercent" type="number" name="MinAttendancePercent" min="0" max="100"
                 value="<%= classroom.minattendancepercent ?? 0 %>" required readonly>
          <span>%</span>
        </div>
        <span class="required">*</span>
      </div>

      <!-- ปีการศึกษา/ภาค -->
      <div class="form-row">
        <label>ปีการศึกษา (พ.ศ.) / ภาค:</label>
        <%
          const _nowTh = (new Date()).getFullYear() + 543;
          const _yearOptions = Array.isArray(yearOptions) && yearOptions.length
              ? yearOptions
              : Array.from({length: 8}, (_,i)=> _nowTh - i);
          const _semesters = Array.isArray(semesters) && semesters.length ? semesters : [1,2,3];
        %>
        <div class="d-flex align-items-center gap-2">
          <select name="academic_year" class="form-control w-auto" required>
            <option value="">ปี</option>
            <% _yearOptions.forEach(y => { %>
              <option value="<%= y %>" <%= Number(classroom.academic_year)===Number(y) ? 'selected':'' %>><%= y %></option>
            <% }) %>
          </select>
          <select name="semester_no" class="form-control w-auto" required>
            <option value="">ภาค</option>
            <% _semesters.forEach(s => { %>
              <option value="<%= s %>" <%= Number(classroom.semester_no ?? classroom.semester)===Number(s) ? 'selected':'' %>><%= s %></option>
            <% }) %>
          </select>
        </div>
        <span class="required">*</span>
      </div>

      <!-- วันเรียน -->
      <div class="form-row">
        <label>วันเรียน:</label>
        <%
          const weekdayTh = ['อาทิตย์','จันทร์','อังคาร','พุธ','พฤหัสบดี','ศุกร์','เสาร์'];
          const currentDow = /^[0-6]$/.test(String(classroom.day_of_week))
              ? weekdayTh[Number(classroom.day_of_week)]
              : (classroom.day_of_week || '');
          const dayChoices = ['จันทร์','อังคาร','พุธ','พฤหัสบดี','ศุกร์','เสาร์','อาทิตย์'];
        %>
        <select name="day_of_week" class="form-control" required>
          <option value="">-- เลือกวัน --</option>
          <% dayChoices.forEach(d => { %>
            <option value="<%= d %>" <%= currentDow===d ? 'selected':'' %>><%= d %></option>
          <% }) %>
        </select>
        <span class="required">*</span>
      </div>

      <!-- เวลาเริ่ม -->
      <div class="form-row">
        <label>เวลาเริ่มเรียน:</label>
        <div class="d-flex gap-2">
          <% const st = String(classroom.start_time || '08:00').slice(0,5).split(':'); %>
          <select name="start_hour" class="form-control w-auto" required>
            <option value="">ชั่วโมง</option>
            <% for (let h=0; h<24; h++){ const hh=('0'+h).slice(-2); %>
              <option value="<%= hh %>" <%= st[0]===hh ? 'selected':'' %>><%= hh %></option>
            <% } %>
          </select>
          <select name="start_minute" class="form-control w-auto" required>
            <option value="">นาที</option>
            <% for (let m=0; m<60; m++){ const mm=('0'+m).slice(-2); %>
              <option value="<%= mm %>" <%= st[1]===mm ? 'selected':'' %>><%= mm %></option>
            <% } %>
          </select>
        </div>
        <span class="required">*</span>
      </div>

      <!-- เวลาเลิก -->
      <div class="form-row">
        <label>เวลาเลิกเรียน:</label>
        <div class="d-flex gap-2">
          <% const et = String(classroom.end_time || '10:00').slice(0,5).split(':'); %>
          <select name="end_hour" class="form-control w-auto" required>
            <option value="">ชั่วโมง</option>
            <% for (let h=0; h<24; h++){ const hh=('0'+h).slice(-2); %>
              <option value="<%= hh %>" <%= et[0]===hh ? 'selected':'' %>><%= hh %></option>
            <% } %>
          </select>
          <select name="end_minute" class="form-control w-auto" required>
            <option value="">นาที</option>
            <% for (let m=0; m<60; m++){ const mm=('0'+m).slice(-2); %>
              <option value="<%= mm %>" <%= et[1]===mm ? 'selected':'' %>><%= mm %></option>
            <% } %>
          </select>
        </div>
        <span class="required">*</span>
      </div>

      <div class="btn-group">
        <button id="btnSubmit" type="submit" class="btn btn-primary">บันทึกการเปลี่ยนแปลง</button>
        <a href="/classroom" class="btn btn-secondary">ย้อนกลับ</a>
      </div>
    </form>
  </div>

  <script>
    // ===== validate เบื้องต้น =====
    function validateForm(){
      const year = document.querySelector('[name="academic_year"]').value.trim();
      const sem  = document.querySelector('[name="semester_no"]').value.trim();
      const dow  = document.querySelector('[name="day_of_week"]').value.trim();
      const sh   = document.querySelector('[name="start_hour"]').value.trim();
      const sm   = document.querySelector('[name="start_minute"]').value.trim();
      const eh   = document.querySelector('[name="end_hour"]').value.trim();
      const em   = document.querySelector('[name="end_minute"]').value.trim();

      if(!year || !sem){ alert('กรุณาเลือก ปีการศึกษา และ ภาคการศึกษา'); return false; }
      if(!dow){ alert('กรุณาเลือกวันเรียน'); return false; }
      if(!sh || !sm || !eh || !em){ alert('กรุณาเลือกเวลาเริ่มและเวลาเลิกให้ครบ'); return false; }

      const start = Number(sh)*60 + Number(sm);
      const end   = Number(eh)*60 + Number(em);
      if(end <= start){ alert('เวลาเลิกเรียนต้องมากกว่าเวลาเริ่มเรียน'); return false; }
      return true;
    }

    // ===== debounce util =====
    function debounce(fn, delay=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),delay); }; }

    // ===== เช็กชื่อซ้ำแบบสด =====
    async function checkDuplicate() {
      const name = document.querySelector('#ClassroomName')?.value?.trim() || '';
      const year = document.querySelector('select[name="academic_year"]')?.value?.trim() || '';
      const sem  = document.querySelector('select[name="semester_no"]')?.value?.trim() || '';
      const exclude_id = '<%= classroom.classroomid %>';

      const $hint = document.getElementById('dupHint');
      const $btn  = document.getElementById('btnSubmit');

      $hint.textContent = '';
      if (!name || !year || !sem) { $btn?.removeAttribute('disabled'); return false; }

      try {
        const qs = new URLSearchParams({ name, academic_year: year, semester_no: sem, exclude_id }).toString();
        const res = await fetch(`/api/classroom/check-duplicate?${qs}`, {
          method: 'GET', credentials: 'same-origin', headers: { 'Accept': 'application/json' }
        });
        if (!res.ok) { $btn?.removeAttribute('disabled'); return false; }
        const data = await res.json();

        if (data.duplicate) {
          $hint.textContent = 'มีชื่อชั้นเรียนนี้อยู่แล้วใน ภาค/ปีการศึกษานี้';
          $btn?.setAttribute('disabled','disabled');
          return true;
        } else {
          $btn?.removeAttribute('disabled');
          return false;
        }
      } catch(e) {
        $btn?.removeAttribute('disabled');
        return false;
      }
    }
    const triggerCheck = debounce(checkDuplicate, 250);

    document.addEventListener('DOMContentLoaded', () => {
      ['#ClassroomName','select[name="academic_year"]','select[name="semester_no"]']
        .forEach(sel => {
          document.querySelector(sel)?.addEventListener('input', triggerCheck);
          document.querySelector(sel)?.addEventListener('change', triggerCheck);
        });
      triggerCheck(); // เช็กครั้งแรกตอนโหลด
    });

    // ===== ตอนกดบันทึก: validate + เช็กซ้ำสด + confirm =====
    async function handleSubmit(e){
      e.preventDefault();
      if (!validateForm()) return false;

      const isDup = await checkDuplicate();
      if (isDup) {
        alert('ชื่อชั้นเรียนซ้ำในภาค/ปีนี้ กรุณาเปลี่ยนชื่อ');
        return false;
      }

      if (confirm('คุณต้องการบันทึกการเปลี่ยนแปลงใช่หรือไม่?')) {
        e.target.submit();
      }
      return false;
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
